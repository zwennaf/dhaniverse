<!DOCTYPE html>
<html>
<head>
    <title>‚úÖ Fixed - Test New User Bank Account Flow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px; }
        h1 { color: #4CAF50; text-align: center; margin-bottom: 30px; }
        button { 
            padding: 12px 25px; margin: 8px; font-size: 14px; cursor: pointer; 
            border: none; border-radius: 8px; background: #4CAF50; color: white;
            transition: all 0.3s ease;
        }
        button:hover { background: #45a049; transform: translateY(-2px); }
        button.danger { background: #f44336; }
        button.danger:hover { background: #da190b; }
        button.info { background: #2196F3; }
        button.info:hover { background: #0b7dda; }
        .output { 
            margin: 15px 0; padding: 15px; border-radius: 8px; 
            font-family: 'Courier New', monospace; font-size: 13px;
            white-space: pre-wrap; max-height: 400px; overflow-y: auto;
        }
        .error { background: rgba(244, 67, 54, 0.2); border-left: 4px solid #f44336; }
        .success { background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; }
        .warning { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #FFC107; }
        .info { background: rgba(33, 150, 243, 0.2); border-left: 4px solid #2196F3; }
        .section { background: rgba(255,255,255,0.05); padding: 20px; margin: 20px 0; border-radius: 10px; }
        .fix-info { background: rgba(76, 175, 80, 0.15); padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ FIXED: New User Bank Account Flow Test</h1>
        
        <div class="fix-info">
            <h3>üîß Root Cause Found & Fixed:</h3>
            <p><strong>Issue:</strong> The database was auto-creating bank accounts for ALL new users during registration (in mongo.ts), without any accountHolder information.</p>
            <p><strong>Result:</strong> New users got accounts with "undefined" names, bypassing the UI form entirely.</p>
            <p><strong>Fix:</strong> Removed auto-account creation from user registration. Now accounts are ONLY created through the proper UI flow.</p>
        </div>
        
        <div class="section">
            <h3>üß™ Test Sequence:</h3>
            <button onclick="step1()">1. Clear User Data (Simulate New User)</button>
            <button onclick="step2()" class="info">2. Test Backend APIs</button>
            <button onclick="step3()" class="info">3. Trigger Account Creation Flow</button>
            <button onclick="step4()" class="danger">4. Monitor Network Activity</button>
            <button onclick="clearOutput()">Clear Output</button>
        </div>
        
        <div id="output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `output ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Override fetch to monitor all API calls
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            const options = args[1] || {};
            
            if (url.includes('bank-account') || url.includes('player-state')) {
                log(`üì° API Call: ${options.method || 'GET'} ${url}`, 'info');
                if (options.body) {
                    try {
                        const body = JSON.parse(options.body);
                        log(`üì§ Request Body: ${JSON.stringify(body, null, 2)}`, 'info');
                    } catch(e) {
                        log(`üì§ Request Body: ${options.body}`, 'info');
                    }
                }
            }
            
            return originalFetch.apply(this, args).then(response => {
                if (url.includes('bank-account') || url.includes('player-state')) {
                    log(`üì• Response: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    // Clone response to read body without consuming it
                    const responseClone = response.clone();
                    responseClone.json().then(data => {
                        log(`üìÑ Response Data: ${JSON.stringify(data, null, 2)}`, 'info');
                    }).catch(() => {
                        log(`üìÑ Response: Non-JSON response`, 'info');
                    });
                }
                return response;
            });
        };

        function step1() {
            log('üßπ Step 1: Clearing all localStorage entries...', 'info');
            
            const beforeKeys = Object.keys(localStorage).filter(k => k.includes('dhaniverse'));
            log(`Found ${beforeKeys.length} dhaniverse keys: ${beforeKeys.join(', ')}`, 'info');
            
            beforeKeys.forEach(key => localStorage.removeItem(key));
            
            const afterKeys = Object.keys(localStorage).filter(k => k.includes('dhaniverse'));
            
            if (afterKeys.length === 0) {
                log(`‚úÖ Successfully cleared all data. User is now in "new user" state.`, 'success');
                
                // Verify new user state
                const hasMetMaya = localStorage.getItem('dhaniverse_has_met_maya') === 'true';
                const hasClaimedMoney = localStorage.getItem('dhaniverse_has_claimed_money') === 'true';
                const onboardingStep = localStorage.getItem('dhaniverse_onboarding_step') || 'not_started';
                const isNewUser = !hasMetMaya && !hasClaimedMoney && onboardingStep === 'not_started';
                
                log(`üÜï New User State Confirmed:
    - hasMetMaya: ${hasMetMaya}
    - hasClaimedMoney: ${hasClaimedMoney} 
    - onboardingStep: ${onboardingStep}
    - isNewUser: ${isNewUser}`, 'success');
            } else {
                log(`‚ùå Failed to clear some keys: ${afterKeys.join(', ')}`, 'error');
            }
        }

        async function step2() {
            log('üî¨ Step 2: Testing backend APIs directly...', 'info');
            
            // Test 1: Check if user has a bank account (should return 404)
            try {
                log('Testing GET /bank-account (should return 404 for new user)...', 'info');
                const response = await fetch('http://localhost:8080/api/game/bank-account', {
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 404) {
                    log('‚úÖ CORRECT: GET /bank-account returns 404 (no account exists)', 'success');
                } else {
                    const data = await response.json();
                    log(`‚ùå UNEXPECTED: GET /bank-account returned ${response.status}. This suggests auto-creation is still happening!`, 'error');
                }
            } catch (error) {
                log(`üîå Cannot connect to backend: ${error.message}`, 'warning');
            }
            
            // Test 2: Try creating account with valid data (should work)
            try {
                log('Testing POST /create with valid data...', 'info');
                const response = await fetch('http://localhost:8080/api/game/bank-account/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountHolder: 'Test User',
                        initialDeposit: 500
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    log(`‚úÖ SUCCESS: Account created successfully for "Test User"`, 'success');
                } else {
                    log(`‚ùå Account creation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Account creation test failed: ${error.message}`, 'error');
            }
            
            // Test 3: Try creating another account (should fail - already exists)
            try {
                log('Testing duplicate account creation (should fail)...', 'info');
                const response = await fetch('http://localhost:8080/api/game/bank-account/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountHolder: 'Another User',
                        initialDeposit: 1000
                    })
                });
                
                const data = await response.json();
                if (response.status === 400 && data.error.includes('already exists')) {
                    log(`‚úÖ CORRECT: Duplicate account creation properly rejected`, 'success');
                } else {
                    log(`‚ùå UNEXPECTED: Duplicate account creation should have failed`, 'error');
                }
            } catch (error) {
                log(`‚ùå Duplicate test failed: ${error.message}`, 'error');
            }
        }

        function step3() {
            log('üéÆ Step 3: Testing frontend account creation flow...', 'info');
            
            try {
                // Simulate what happens when user talks to bank manager
                log('Dispatching open-bank-account-creation-flow event...', 'info');
                
                // Listen for the form opening
                const formCheckInterval = setInterval(() => {
                    const formExists = document.querySelector('[data-flow-panel]');
                    if (formExists) {
                        log('‚úÖ SUCCESS: Bank account creation form is now visible!', 'success');
                        log('üéØ Expected: User should see form with name and deposit fields', 'success');
                        clearInterval(formCheckInterval);
                    }
                }, 500);
                
                // Listen for account creation completion
                window.addEventListener('bank-account-creation-finished', function handler(e) {
                    window.removeEventListener('bank-account-creation-finished', handler);
                    log(`‚úÖ Account creation completed: ${JSON.stringify(e.detail)}`, 'success');
                }, { once: true });
                
                // Trigger the bank manager interaction
                window.dispatchEvent(new CustomEvent('open-bank-account-creation-flow'));
                
                // Stop checking after 10 seconds
                setTimeout(() => {
                    clearInterval(formCheckInterval);
                    const formExists = document.querySelector('[data-flow-panel]');
                    if (!formExists) {
                        log('‚ùå PROBLEM: Form did not appear after 10 seconds', 'error');
                        log('üí° This could indicate the flow is still being bypassed', 'warning');
                    }
                }, 10000);
                
            } catch (error) {
                log(`‚ùå Frontend flow test failed: ${error.message}`, 'error');
            }
        }

        function step4() {
            log('üìä Step 4: Network monitoring active...', 'info');
            log('All bank-account and player-state API calls will be logged above.', 'info');
            log('üí° Now go to the main game (http://localhost:3000) and talk to the bank manager.', 'warning');
            log('üîç Watch for any unexpected API calls or account creation attempts.', 'info');
        }

        // Initialize monitoring on page load
        log('üöÄ Bank Account Creation Test Tool Loaded', 'success');
        log('üìã This tool will help verify that new users see the account creation form properly.', 'info');
        log('‚ñ∂Ô∏è Start with Step 1 to simulate a new user state.', 'info');
    </script>
</body>
</html>
